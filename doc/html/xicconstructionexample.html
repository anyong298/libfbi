<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>tree: A Mass Spectrometry Example: Calculating Extracted Ion Currents (XICs)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="XicConstructionExample">A Mass Spectrometry Example: Calculating Extracted Ion Currents (XICs) </a></h1><h2><a class="anchor" id="setup">
Setup</a></h2>
<p>A common problem in mass spectrometry data analysis is the preprocessing of high-resolution liquid chromatography/mass spectrometry data (LC/MS). In general, such data consists of a set of mass spectra that are acquired across a liquid chromatography gradient, yielding approximately one MS1 spectrum per second. The preprocessing task is to extract the ion current for each observed species from these data.</p>
<p>In the case at hand, we follow a somewhat established procedure to extract the XIC: </p>
<ul>
<li>We first determine the centroid of each local maximum in the m/z domain. This step and the underlying methods have thoroughly been described in a number of publications (e.g. [Cox and Mann, 2008]) and the remainder of the example assumes that the data is available in the form of a list of centroids that (to keep things simple) can be read from disk. </li>
<li>We then determine which centroids belong together to form a XIC. This is where <code>libfbi</code> comes into play: two centroids belong to the same XIC if their uncertainty boxes overlap. The centroid uncertainty is generally obtained by the centroiding procedure, however, to keep things simple, we here only use an m/z-dependent parts-per-million (ppm) estimate that allows for a simplified description of the mass accuracy behavior of an LTQ Orbitrap instrument. Furthermore, instead of using the retention time measurement provided by the mass analyzer, we rely on the spectrum number; this information is more robust as the retention time differences between runs can vary due to varying numbers of fragementation scans that are acquired in parallel.</li>
</ul>
<p>All of the following material is provided as the <code>example-xic-construction</code> sample application which is provided together with the <code>libfbi</code> package. The complete source and header files reside in the <code>example/</code> subdirectory of the <code>libfbi</code> project.</p>
<h2><a class="anchor" id="prep">
Necessary Preparations and Definitions</a></h2>
<p>In order to tackle the XIC extraction task with <code>libfbi</code>, we first need to define a data type that holds the centroid information:</p>
<div class="fragment"><pre class="fragment"><span class="keyword">struct </span>Centroid 
{
  <span class="keywordtype">double</span> rt_;
  <span class="keywordtype">double</span> mz_;
  <span class="keywordtype">double</span> sn_;
  <span class="keywordtype">double</span> abundance_;
  Centroid(<span class="keyword">const</span> <span class="keywordtype">double</span> &amp;rt, <span class="keyword">const</span> <span class="keywordtype">double</span>&amp; mz,
    <span class="keyword">const</span> <span class="keywordtype">double</span> &amp; sn, <span class="keyword">const</span> <span class="keywordtype">double</span> &amp; abundance) 
    : rt_(rt), mz_(mz), sn_(sn), abundance_(abundance) {}
};
</pre></div><p>The <code>Centrod</code> struct holds all information available for a single centroid. We now procedd to provide the code necessary to enable <code>libfbi</code> to derive the uncertainty information for a centroid.</p>
<p>First, we tell <code>libfbi</code> that <code>Centroid</code> is a two-dimensional measurement (we will make use of the mass/charge ratio and the spectrum number):</p>
<div class="fragment"><pre class="fragment"><span class="keyword">namespace </span>fbi {

<span class="keyword">template</span>&lt;&gt;
<span class="keyword">struct </span>Traits&lt;Centroid&gt; : mpl::TraitsGenerator&lt;
  double, double&gt; {};

} <span class="comment">// end namespace fbi</span>
</pre></div><p> Note that <code>Traits&lt;Centroid&gt;</code> needs to be specialized in the <code>fbi</code> namespace.</p>
<p>We now need to provide a wrapper/adapter class, through which <code>libfbi</code> will access the information in the <code>Centroid</code> objects. In fact, <code>libfbi</code> never accesses the <code>Centroid</code> objects themselves but only requests their uncertainty ranges. In other words, we need to provide a wrapper that transforms each <code>Centroid</code> coordinate (the m/z measurement and the spectrum number in our case) into a <code><a class="elRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00269.html">std::pair</a></code> that holds the corresponding uncertainty range. Practically, this translates to providing an adapter class that has a template member function <code>get&lt;Dim&gt;()</code> and a corresponding specialization for each dimension that will be queried by <code>libfbi</code>. A potential adapter class looks like this:</p>
<div class="fragment"><pre class="fragment"><span class="keyword">struct </span>BoxGenerator
{
  <span class="keyword">template</span> &lt;<span class="keywordtype">size_t</span> N&gt;
  <span class="keyword">typename</span> std::tuple_element&lt;N, 
    <span class="keyword">typename</span> <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00709.html">fbi::Traits&lt;Centroid&gt;::key_type</a>&gt;::type 
  <span class="keyword">get</span>(<span class="keyword">const</span> Centroid &amp;) <span class="keyword">const</span>;

  <span class="keywordtype">double</span> mzOffset_;
  <span class="keywordtype">double</span> mzWindowPpm_;
  <span class="keywordtype">double</span> snOffset_;
  <span class="keywordtype">double</span> snWindow_;

  BoxGenerator(<span class="keywordtype">double</span> mzWindowPpm, <span class="keywordtype">double</span> snWindow)
    : mzOffset_(0.0), mzWindowPpm_(mzWindowPpm),
      snOffset_(0.0), snWindow_(snWindow)
  {}

  BoxGenerator(<span class="keywordtype">double</span> mzOffset, <span class="keywordtype">double</span> mzWindowPpm, 
    <span class="keywordtype">double</span> snOffset, <span class="keywordtype">double</span> snWindow)
    : mzOffset_(mzOffset), mzWindowPpm_(mzWindowPpm),
      snOffset_(snOffset), snWindow_(snWindow)
  {}
};
</pre></div><p> It is recommended to use the return type specification for <code>get&lt;T&gt;()</code> as illustrated in this example.</p>
<p><code>BoxGenerator</code> defines a class that holds all functions and additional information (such as the ppm values used to determine the m/z interval size, and the allowed number of scans in which a centroid has been missed) neccessary to derive the m/z and spectrum number intervals. The complete template specialization of the respective interval calculation functions is thus very simple:</p>
<div class="fragment"><pre class="fragment"><span class="keyword">template</span> &lt;&gt;
<a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00269.html">std::pair&lt;double, double&gt;</a>  
BoxGenerator::get&lt;0&gt;(<span class="keyword">const</span> Centroid &amp; centroid) <span class="keyword">const</span> 
{
  <span class="keywordflow">return</span> <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a01138.html#a9345a6e2e39831b4291cac2e52a15792">std::make_pair</a>(
    mzOffset_ + centroid.mz_* (1-  mzWindowPpm_* 1E-6), 
    mzOffset_ + centroid.mz_* (1+ mzWindowPpm_ * 1E-6) );
}

<span class="keyword">template</span> &lt;&gt;
<a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00269.html">std::pair&lt;double, double&gt;</a>  
BoxGenerator::get&lt;1&gt;(<span class="keyword">const</span> Centroid &amp; centroid) <span class="keyword">const</span>
{
  <span class="keywordflow">return</span> <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a01138.html#a9345a6e2e39831b4291cac2e52a15792">std::make_pair</a>(
    snOffset_ + centroid.sn_ - snWindow_ - 0.3, 
    snOffset_ + centroid.sn_ + snWindow_ + 0.3 );
}
</pre></div><p>This finalizes the setup and preparation work that needs to be carried out to make use of <code>libfbi</code> for XIC determination. Hence, let's turn to writing the respective main program.</p>
<h2><a class="anchor" id="main">
Using libfbi in your main program</a></h2>
<p>The first step to XIC determination is to read the centroid data from disk and into <code>Centroid</code> instances:</p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argn, <span class="keywordtype">char</span>* argv[]) {
    <span class="comment">//</span>
    <span class="comment">// ... </span>
    <span class="comment">//</span>

    <span class="comment">// read centroid data from file</span>
    <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00730.html">std::vector&lt;Centroid&gt;</a> centroids = parseFile(options);

    <span class="comment">//</span>
    <span class="comment">// ... </span>
    <span class="comment">//</span>
</pre></div><p>XIC calculation is a self-intersection problem: within one set of boxes (each with an (m/z, spectrum number) measurement pair at its center), we would like to find all boxes that intersect with each other. For this kind of problem <code>libfbi</code> provides the <code>SetA&lt;T</code>,Dim..&gt;intersect&lt;T,F..&gt;(...) function:</p>
<div class="fragment"><pre class="fragment">    <span class="keyword">auto</span> adjList = SetA&lt;Centroid, 0, 1&gt;::
      intersect(centroids, BoxGenerator(2, 2.1), BoxGenerator(2, 2.1));
</pre></div><p>This tells <code>libfbi</code> to carry out a box intersection in dimensions 0 and 1, using a 4ppm x 4.2 scans interval for each measurement (first <code>BoxGenerator</code> instance) and query boxes of the same size (second <code>BoxGenerator</code> instance).</p>
<p><code>libfbi</code> now generates an adjacency list <code>adjList</code> that describes a graph in which all centroids (the vertices of the graph) whose uncertainty boxes overlap are connected with an edge. Determining the XICs now is a simple matter of determining the connected components of the graph:</p>
<div class="fragment"><pre class="fragment">    <span class="keyword">typedef</span> SetA&lt;Centroid, 1, 2&gt;::IntType LabelType;
    <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00730.html">std::vector&lt;LabelType&gt;</a> labels;
    findConnectedComponents(adjList, labels); 
</pre></div><p>Finally, we can write the results to a text file and exit: </p>
<div class="fragment"><pre class="fragment">    <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00387.html">std::ofstream</a> ofs(options.outputfileName_.c_str());
    ofs.setf(<a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00510.html#ab68a9e528eb897d85741f7a21adf4368">std::ios::fixed</a>, <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00510.html#a82663733691c649e8138a0fa959cb8c4">std::ios::floatfield</a>);
    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0;i &lt; centroids.<a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00730.html#a49e9afae414f8d8e3a2e1221c3a050c6">size</a>();++i) {
    Centroid&amp; c = centroids[i];
    ofs &lt;&lt; c.rt_ &lt;&lt; <span class="stringliteral">&quot;\t&quot;</span> &lt;&lt; c.mz_ &lt;&lt; <span class="stringliteral">&quot;\t&quot;</span> &lt;&lt; c.sn_ &lt;&lt; <span class="stringliteral">&quot;\t&quot;</span> 
      &lt;&lt; c.abundance_ &lt;&lt; <span class="stringliteral">&quot;\t&quot;</span> &lt;&lt; labels[i] &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
    }
    <span class="keywordflow">return</span> 0;
}
</pre></div> </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Friends</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on Mon Dec 20 16:40:48 2010 for tree by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
