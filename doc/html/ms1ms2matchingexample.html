<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>libfbi: A Mass Spectrometry Example: Matching high- and low-accuracy precursors</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="Ms1Ms2MatchingExample">A Mass Spectrometry Example: Matching high- and low-accuracy precursors </a></h1><h2><a class="anchor" id="setup">
Setup</a></h2>
<p>Another common preprocessing step in mass spectrometry data analysis is the replacement of low-accuracy precursor masses (which come from the instrument prescan) with their high mass accuracy couterparts (which are acquired in the MS1 full scan). In the example at hand, we assume that the data stem from a hybrid Thermo LTQ/Orbitrap (classic) instrument, with a prescan resolution of 7500 and a MS1 full scan resolution of 60000.</p>
<h2><a class="anchor" id="method">
Method</a></h2>
<p>We use an approach similar similar to what is sketched in the first MS example to generate extracted ion currents (XICs). Given the XICs and all precursor masses, we would like to determine the closest cross-set neighbors in the XIC and precursor sets, taking into consideration the error bounds that are associated with (i) the low-accuracy precursor, (ii) the XIC m/z, and (iii) the XIC retention time measurements. Methodologically,</p>
<ul>
<li>we use fast box intersection to derive sets of potential (XIC, parent mass) pairs </li>
<li>within these sets we need to select a pair by e.g. minimizing the m/z distance between the XIC and the precursor. In the example at hand, conflict resolution is kept overly simple and we accept the first candidate.</li>
</ul>
<h2><a class="anchor" id="setting_up">
Setting Things Up</a></h2>
<p>First order of business is the definition of the user classes: a class to represent an XIC and a class to hold the scan precursor information.</p>
<div class="fragment"><pre class="fragment"><span class="keyword">struct </span>Xic
{
    <span class="keywordtype">double</span> rt_;
    <span class="keywordtype">double</span> mz_;
    <span class="keywordtype">double</span> abundance_;
    Xic(<span class="keyword">const</span> <span class="keywordtype">double</span> &amp;rt, <span class="keyword">const</span> <span class="keywordtype">double</span>&amp; mz, <span class="keyword">const</span> <span class="keywordtype">double</span> &amp; abundance) 
      : rt_(rt), mz_(mz), abundance_(abundance) {}
};

<span class="keyword">struct </span>MS2Scan
{
    <span class="keywordtype">double</span> rt_;
    <span class="keywordtype">double</span> mz_;
    <span class="comment">// some more definitions for the ions etc...</span>
    MS2Scan(<span class="keyword">const</span> <span class="keywordtype">double</span> &amp;rt, <span class="keyword">const</span> <span class="keywordtype">double</span>&amp; mz) : rt_(rt), mz_(mz) {}
};
</pre></div><p>Then we need to provide some type information to <code>libfbi:</code> </p>
<div class="fragment"><pre class="fragment"><span class="keyword">namespace </span>fbi {
<span class="keyword">template</span>&lt;&gt; <span class="keyword">struct </span>Traits&lt;Xic&gt; : mpl::TraitsGenerator&lt;double, double&gt; {};
<span class="keyword">template</span>&lt;&gt; <span class="keyword">struct </span>Traits&lt;MS2Scan&gt; : mpl::TraitsGenerator&lt;double, double&gt; {};
} 
</pre></div><p> This tells  libfbi that both, the XIC and the ms2scan, can be queried in two dimensions, each of which is of type double (i.e. a floating point number). Note, that it is not necessary to inform <code>libfbi</code> about all data members of a class if these data members are not used in the fast box intersection process. For example, the <code>Xic</code> struct has an <code>abundance</code> member that is irrelevant for the intersection task at hand and is thus not included in <code>Traits&lt;Xic&gt;</code>.</p>
<p>Now we need to write the <code>Xic</code> and <code>MS2Scan</code> accessor/adapter functions that allow libfbi to derive interval information in each dimension for each ms2scan and XIC measurement. For the <code>Xic</code> struct, this yields</p>
<div class="fragment"><pre class="fragment"><span class="keyword">struct </span>XicBoxGenerator
{
  <span class="keyword">template</span> &lt;<span class="keywordtype">size_t</span> N&gt;
  <span class="keyword">typename</span> std::tuple_element&lt;N, 
    <span class="keyword">typename</span> <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00709.html">fbi::Traits&lt;Xic&gt;::key_type</a>&gt;::type 
  <span class="keyword">get</span>(<span class="keyword">const</span> Xic &amp;) <span class="keyword">const</span>;

  <span class="keywordtype">double</span> fullScanPpm_;
  <span class="keywordtype">double</span> rtWindow_;

  XicBoxGenerator(<span class="keywordtype">double</span> fullScanPpm, <span class="keywordtype">double</span> rtWindow)
    : fullScanPpm_(fullScanPpm), rtWindow_(rtWindow)
  {}
};

<span class="keyword">template</span> &lt;&gt;
<a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00269.html">std::pair&lt;double, double&gt;</a>  
XicBoxGenerator::get&lt;0&gt;(<span class="keyword">const</span> Xic&amp; xic) <span class="keyword">const</span> 
{
  <span class="keywordflow">return</span> <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a01138.html#a9345a6e2e39831b4291cac2e52a15792">std::make_pair</a>(
    xic.mz_* (1 - fullScanPpm_ * 1E-6), 
    xic.mz_* (1 + fullScanPpm_ * 1E-6));
}

<span class="keyword">template</span> &lt;&gt;
<a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00269.html">std::pair&lt;double, double&gt;</a>  
XicBoxGenerator::get&lt;1&gt;(<span class="keyword">const</span> Xic &amp; xic) <span class="keyword">const</span>
{
  <span class="keywordflow">return</span> <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a01138.html#a9345a6e2e39831b4291cac2e52a15792">std::make_pair</a>(xic.rt_ - rtWindow_, xic.rt_ + rtWindow_);
}
</pre></div><p>And for the <code>MS2Scan</code> struct, we have</p>
<div class="fragment"><pre class="fragment"><span class="keyword">struct </span>MS2ScanBoxGenerator
{
  <span class="keyword">template</span> &lt;<span class="keywordtype">size_t</span> N&gt;
  <span class="keyword">typename</span> std::tuple_element&lt;N, 
    <span class="keyword">typename</span> <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00709.html">fbi::Traits&lt;MS2Scan&gt;::key_type</a>&gt;::type 
  <span class="keyword">get</span>(<span class="keyword">const</span> MS2Scan &amp;) <span class="keyword">const</span>;

  <span class="keywordtype">double</span> preScanPpm_;
  <span class="keywordtype">double</span> rtWindow_;

  MS2ScanBoxGenerator(<span class="keywordtype">double</span> preScanPpm, <span class="keywordtype">double</span> rtWindow)
    : preScanPpm_(preScanPpm), rtWindow_(rtWindow)
  {}
};

<span class="keyword">template</span> &lt;&gt;
<a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00269.html">std::pair&lt;double, double&gt;</a>  
MS2ScanBoxGenerator::get&lt;0&gt;(<span class="keyword">const</span> MS2Scan&amp; ms2scan) <span class="keyword">const</span> 
{
  <span class="keywordflow">return</span> <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a01138.html#a9345a6e2e39831b4291cac2e52a15792">std::make_pair</a>(
    ms2scan.mz_* (1 - preScanPpm_ * 1E-6), 
    ms2scan.mz_* (1 + preScanPpm_ * 1E-6));
}

<span class="keyword">template</span> &lt;&gt;
<a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00269.html">std::pair&lt;double, double&gt;</a>  
MS2ScanBoxGenerator::get&lt;1&gt;(<span class="keyword">const</span> MS2Scan &amp; ms2scan) <span class="keyword">const</span>
{
  <span class="keywordflow">return</span> <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a01138.html#a9345a6e2e39831b4291cac2e52a15792">std::make_pair</a>(ms2scan.rt_ - rtWindow_, ms2scan.rt_ + rtWindow_);
}
</pre></div><p>We also define two helper functions, that allow us to read <code>Xic</code> and <code>MS2Scan</code> data from text files:</p>
<div class="fragment"><pre class="fragment"><a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00730.html">std::vector&lt;Xic&gt;</a> parseXicFile(ProgramOptions&amp; options);
<a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00730.html">std::vector&lt;MS2Scan&gt;</a> parseMS2ScanFile(ProgramOptions &amp; options);
</pre></div><p>The functions that a <code>ProgramOptions</code> reference that holds program parameters; see the implementation in the <code>examples</code> directory for their definition and the program option parsign code (based on boost::program_options).</p>
<h2><a class="anchor" id="main">
Using libfbi in your main program</a></h2>
<p>With the above preparations carried out, writing the code that intersects the XIC and precursor sets is straightforward. We start and read the data:</p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])
{
    <span class="keyword">using namespace </span>fbi;

    ProgramOptions options;
    <span class="keywordflow">if</span> (parseProgramOptions(argc, argv, options) != 0) {
        <span class="keywordflow">return</span> -1;
    }
    <span class="comment">// load data</span>
    <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00730.html">std::vector&lt;Xic&gt;</a> xics = parseXicFile(options);
    <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00730.html">std::vector&lt;MS2Scan&gt;</a> ms2scans = parseMS2ScanFile(options);
</pre></div><p>With the data available, we carry out the intersection:</p>
<div class="fragment"><pre class="fragment">    <span class="keyword">auto</span> adjList = SetA&lt;Xic, 0, 1&gt;::SetB&lt;MS2Scan, 0, 1&gt;::intersect(
      xics, XicBoxGenerator(options.fullscanPpm_, options.rtWindow_),
      ms2scans, MS2ScanBoxGenerator(options.prescanPpm_, options.rtWindow_));
</pre></div><p>The <code>XicBoxGenerator</code> and <code>MS2ScanBoxGenerator</code> instances will always return the proper intervals for a given XIC and/or precursor. Determining the high-resolution precursor mass for each low-resolution precursor now boils down to resolving the conflict between the pair candidates. We choose the precursor with the smallest m/z distance:</p>
<div class="fragment"><pre class="fragment">    <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00387.html">std::ofstream</a> ofs(options.outputFileName_.c_str());
    ofs.setf(<a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00510.html#ab68a9e528eb897d85741f7a21adf4368">std::ios::fixed</a>, <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00510.html#a82663733691c649e8138a0fa959cb8c4">std::ios::floatfield</a>);
    <span class="keywordtype">size_t</span> nXics = xics.<a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00730.html#a49e9afae414f8d8e3a2e1221c3a050c6">size</a>();
    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; nXics; ++i) {
        <span class="keywordflow">if</span> (!adjList[i].empty()) {
            <span class="keyword">typedef</span> <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a00270.html#a3d51d0ac851fe6c1b5d59e3b5aacfe57">std::set&lt;unsigned int&gt;::const_iterator</a> SI;
            SI best = adjList[i].begin();
            <span class="keywordtype">double</span> bestDist = <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a01177.html#ga8010118c8f0472172a808754940c3b66">std::numeric_limits&lt;double&gt;::max</a>();
            <span class="comment">// resolve conflict by choosing the closest m/z</span>
            <span class="keywordflow">for</span> (SI j = adjList[i].begin(); j != adjList[i].end(); ++j) {
                <span class="keywordtype">size_t</span> k = *j - nXics;
                <span class="keywordtype">double</span> dist = <a class="codeRef" doxygen="libstdc++.tag:http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/" href="http://gcc.gnu.org/onlinedocs/libstdc++/latest-doxygen/a01166.html#ga0e13df7b78190fc3a176cfe9c9a764bc">std::abs</a>(xics[i].mz_ - ms2scans[k].mz_);
                <span class="keywordflow">if</span> (dist &lt; bestDist) {
                    best = j;
                    bestDist = dist;
                }
            }
            <span class="comment">// print the pair (current precursor -&gt; new precursor)</span>
            <span class="keywordtype">size_t</span> k = *best - nXics;
            ofs &lt;&lt; xics[i].mz_ &lt;&lt; <span class="charliteral">&apos;\t&apos;</span> &lt;&lt; xics[i].rt_
              &lt;&lt; <span class="stringliteral">&quot;\t-&gt;\t&quot;</span> &lt;&lt; ms2scans[k].mz_ &lt;&lt; <span class="charliteral">&apos;\t&apos;</span> &lt;&lt; ms2scans[k].rt_ &lt;&lt; <span class="charliteral">&apos;\n&apos;</span>;
       }
    }
    <span class="keywordflow">return</span> 0;
}
</pre></div> </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Friends</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on Thu Dec 23 10:01:51 2010 for libfbi by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
